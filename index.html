<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ðŸŽ¯ PERFORMANCE (Critical Meta) -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#3b82f6">
  <meta name="color-scheme" content="light dark">

  <!-- ðŸŽ¯ SECURITY (CSP)
       NOTE: You currently allow 'unsafe-inline'. This file keeps your inline module script.
       If you later move the bootstrap to an external file, you can remove 'unsafe-inline'. -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' https://unpkg.com 'unsafe-inline';
                 style-src 'self' 'unsafe-inline';
                 connect-src 'self' https://unpkg.com;
                 img-src 'self' data:;
                 font-src 'self';
                 media-src 'self';
                 object-src 'none';
                 base-uri 'self';
                 frame-ancestors 'none';">

  <!-- ðŸŽ¯ PWA / iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Violin Mastery Quest">
  <meta name="application-name" content="VMQ">

  <!-- ðŸŽ¯ SEO + Social -->
  <meta name="description" content="Violin Mastery Quest v3.0 - adaptive violin training: intervals, fingerboard, scales, rhythm, SM-2, AI coach">
  <title>Violin Mastery Quest</title>

  <!-- ðŸŽ¯ Open Graph -->
  <meta property="og:title" content="Violin Mastery Quest">
  <meta property="og:description" content="Adaptive violin training: Bieler Method + spaced repetition + AI coach">
  <meta property="og:image" content="./icons/icon-512.png">
  <meta property="og:type" content="website">

  <!-- ðŸŽ¯ PWA Manifest -->
  <link rel="manifest" href="./manifest.json">

  <!-- ðŸŽ¯ Icons -->
  <link rel="icon" type="image/png" sizes="16x16" href="./icons/icon-16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./icons/icon-32.png">
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./icons/icon-180.png">

  <!-- ðŸŽ¯ PERFORMANCE -->
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="dns-prefetch" href="https://unpkg.com">

  <!-- ðŸŽ¯ Critical CSS -->
  <link rel="preload" href="./css/base.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="./css/base.css"></noscript>
  <link rel="preload" href="./css/components.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="./css/components.css"></noscript>
  <link rel="preload" href="./css/themes.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="./css/themes.css"></noscript>
  <link rel="preload" href="./css/animations.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="./css/animations.css"></noscript>

  <!-- âœ… Module preloads (better than preload as="script" for ESM) -->
  <link rel="modulepreload" href="./js/config/routeManifest.js">
  <link rel="modulepreload" href="./js/App.js">
</head>

<body>
  <!-- âœ… SHELL UI OUTSIDE React root (prevents React from wiping it mid-bootstrap) -->
  <div class="loading-screen active" id="loading-screen" aria-live="polite">
    <div class="loading-spinner"></div>
    <div class="loading-content">
      <h1 class="loading-title">Violin Mastery Quest</h1>
      <p class="loading-subtitle">Adaptive modules â€¢ Offline-ready</p>
      <div class="loading-progress">
        <div class="progress-bar">
          <div class="progress-fill" style="--width: 0%"></div>
        </div>
      </div>
      <p class="loading-status" id="loading-status">Initializing...</p>
      <div class="engine-status" id="engine-status" aria-live="polite"></div>
    </div>
  </div>

  <div class="toast-container" id="toast-container"></div>

  <div class="diagnostic-overlay" id="diagnostic-overlay" style="display:none;">
    <div class="diagnostic-content">
      <h2>ðŸ”§ VMQ Diagnostic Mode</h2>
      <pre id="diagnostic-log"></pre>
      <button id="diagnostic-reload" class="btn btn-primary">Reload App</button>
    </div>
  </div>

  <!-- âœ… React Mount Point -->
  <div id="root"></div>

  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- VMQ BOOTSTRAP (Shell-level; keep lightweight) -->
  <script type="module">
    import {
      ROUTE_TO_COMPONENT_FILE,
      normalizeRouteSlug
    } from './js/config/routeManifest.js';

    // Use the same storage module your App.js uses (config/storage.js)
    import { loadJSON, saveJSON } from './js/config/storage.js';

    const startTime = performance.now();
    window.vmqMetrics = window.vmqMetrics || {
      fcp: 0, fid: 0, cls: 0,
      loadTime: 0, engineInitTime: 0, mlWarmupTime: 0
    };

    const isDiagnosticMode =
      window.location.search.includes('vmq-diagnostics') ||
      window.location.search.includes('debug=true');

    const diagnosticLog = [];
    function logDiagnostic(category, message, data = null) {
      const timestamp = (performance.now() - startTime).toFixed(2);
      const logEntry = `[${timestamp}ms] [${category}] ${message}${data ? ' ' + JSON.stringify(data) : ''}`;
      diagnosticLog.push(logEntry);

      if (isDiagnosticMode) {
        console.log(`%cVMQ Diagnostics: ${logEntry}`, 'color: #3b82f6; font-weight: bold;');
        const logEl = document.getElementById('diagnostic-log');
        if (logEl) logEl.textContent = diagnosticLog.join('\\n');
      }
    }

    // Shell error boundary
    window.addEventListener('error', (event) => {
      logDiagnostic('ERROR', event.message, { filename: event.filename, lineno: event.lineno });
      const overlay = document.getElementById('diagnostic-overlay');
      if (overlay && isDiagnosticMode) overlay.style.display = 'flex';
    });
    window.addEventListener('unhandledrejection', (event) => {
      logDiagnostic('PROMISE', event.reason?.message || 'Unhandled rejection', event.reason);
    });

    // Feature-flag check (fail-open)
    function checkFeature(featureName) {
      try {
        const features = window.VMQ?.FEATURES || window.VMQ?.features || {};
        const isEnabled = features[featureName]?.enabled !== false;
        logDiagnostic('FEATURE', `${featureName}: ${isEnabled ? 'âœ…' : 'âŒ'}`);
        return isEnabled;
      } catch (e) {
        logDiagnostic('FEATURE', `${featureName}: âš ï¸ check failed`, e);
        return true;
      }
    }

    // Engine health â€” treat missing optional engines as â€œdegradedâ€, not fatal.
    const requiredEngines = [
      { name: 'audioEngine', critical: true },
      { name: 'spacedRepetition', critical: false },
      { name: 'gamification', critical: true },
      { name: 'analytics', critical: false },
      { name: 'sessionTracker', critical: true },
      { name: 'difficultyAdapter', critical: false }
    ];

    async function checkEngineHealth() {
      const statusEl = document.getElementById('engine-status');
      const status = {};
      let allCriticalOk = true;

      for (const e of requiredEngines) {
        try {
          const module = await import(`./js/engines/${e.name}.js`);
          const isHealthy = !!(module && (module.default || module[e.name]));
          status[e.name] = isHealthy ? 'âœ…' : 'âŒ';
          if (!isHealthy && e.critical) allCriticalOk = false;
          logDiagnostic('ENGINE', `${e.name}: ${isHealthy ? 'healthy' : 'failed'}`, { critical: e.critical });
        } catch (err) {
          status[e.name] = 'âŒ';
          if (e.critical) allCriticalOk = false;
          logDiagnostic('ENGINE', `${e.name}: failed to load`, { critical: e.critical, err: String(err?.message || err) });
        }
      }

      if (statusEl) {
        statusEl.innerHTML = Object.entries(status)
          .map(([name, icon]) => `<span class="engine-indicator">${icon} ${name}</span>`)
          .join('');
      }

      return allCriticalOk;
    }

    async function warmupMLModels() {
      if (!checkFeature('analytics') && !checkFeature('difficultyAdapter')) {
        logDiagnostic('ML', 'ML features disabled, skipping warmup');
        return;
      }

      const mlStart = performance.now();
      logDiagnostic('ML', 'Warming up models...');

      try {
        const [analyticsMod, difficultyMod] = await Promise.all([
          import('./js/engines/analytics.js'),
          import('./js/engines/difficultyAdapter.js')
        ]);

        if (analyticsMod.analyzePerformance) {
          await analyticsMod.analyzePerformance('week', { includePredictions: false, includePatterns: true });
          logDiagnostic('ML', 'Analytics model ready');
        }
        if (difficultyMod.getUserLevel) {
          await difficultyMod.getUserLevel();
          logDiagnostic('ML', 'Difficulty model ready');
        }
      } catch (e) {
        logDiagnostic('ML', 'Warmup failed', e);
      }

      window.vmqMetrics.mlWarmupTime = Math.round(performance.now() - mlStart);
      logDiagnostic('ML', `Warmup complete: ${window.vmqMetrics.mlWarmupTime}ms`);
    }

    // âœ… Prefetch resolver uses the SHARED manifest (no duplication)
    function resolveComponentHref(routeOrId) {
      if (!routeOrId) return null;
      const raw = String(routeOrId).replace(/^#/, '').split('?')[0].trim();
      if (!raw) return null;

      const key = normalizeRouteSlug(raw);
      const file = ROUTE_TO_COMPONENT_FILE[key];
      return file ? `./js/components/${file}` : null;
    }

    function prefetchScript(href) {
      if (!href) return;
      if (document.head.querySelector(`link[rel="prefetch"][href="${href}"]`)) return;

      const link = document.createElement('link');
      link.rel = 'prefetch';
      link.as = 'script';
      link.href = href;
      document.head.appendChild(link);
    }

    async function prefetchUserModules() {
      try {
        // Align keys with your actual storage keys if you have them; this is safe fallback.
        const profile = loadJSON('vmq-profile', { level: 'beginner' });

        const modulesToPrefetch = {
          beginner: ['intervals', 'keys', 'rhythm'],
          intermediate: ['bieler', 'scales', 'fingerboard'],
          advanced: ['bieler', 'scales', 'flashcards']
        };

        const modules = modulesToPrefetch[profile.level] || modulesToPrefetch.beginner;

        for (const routeOrId of modules) {
          prefetchScript(resolveComponentHref(routeOrId));
        }

        logDiagnostic('PREFETCH', `Prefetched modules for ${profile.level}`, modules);
      } catch (e) {
        logDiagnostic('PREFETCH', 'Failed', e);
      }
    }

    // Service Worker registration (SINGLE OWNER: index.html)
    async function registerServiceWorker() {
      if (window.__VMQ_SW_REGISTERED__) {
        logDiagnostic('SW', 'Already registered (guard flag set)');
        return;
      }
      if (!checkFeature('pwaOffline') || !('serviceWorker' in navigator)) {
        logDiagnostic('SW', 'Service Worker disabled or not supported');
        return;
      }

      try {
        const existing = await navigator.serviceWorker.getRegistration('./');
        let registration = existing;

        if (!registration) {
          window.__VMQ_SW_REGISTERED__ = true;
          window.__VMQ_SW_OWNER__ = 'index.html';

          registration = await navigator.serviceWorker.register('./sw.js', {
            scope: './',
            updateViaCache: 'none'
          });
          logDiagnostic('SW', `Registered: ${registration.scope}`);
        } else {
          window.__VMQ_SW_REGISTERED__ = true;
          window.__VMQ_SW_OWNER__ = window.__VMQ_SW_OWNER__ || 'existing';
          logDiagnostic('SW', `Using existing registration: ${registration.scope}`);
        }

        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker?.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              logDiagnostic('SW', 'Update available');
              window.dispatchEvent(new CustomEvent('vmq-update-available', {
                detail: { version: '3.0', cacheBust: Date.now() }
              }));
            }
          });
        });

        // Optional: background sync tags (must match your sw.js listeners)
        if (registration.sync) {
          try { await registration.sync.register('sync-analytics'); logDiagnostic('SYNC', 'sync-analytics registered'); } catch (e) { logDiagnostic('SYNC', 'sync-analytics failed', e); }
          try { await registration.sync.register('sync-sm2');       logDiagnostic('SYNC', 'sync-sm2 registered'); }       catch (e) { logDiagnostic('SYNC', 'sync-sm2 failed', e); }
        }

        if (registration.periodicSync) {
          try {
            await registration.periodicSync.register('check-due-items', { minInterval: 30 * 60 * 1000 });
            logDiagnostic('SYNC', 'Periodic sync registered: check-due-items');
          } catch (e) {
            logDiagnostic('SYNC', 'Periodic sync failed: check-due-items', e);
          }
        }
      } catch (err) {
        window.__VMQ_SW_REGISTERED__ = false;
        logDiagnostic('SW', 'Registration failed', err);
      }
    }

    function adaptLoadingToConnection() {
      const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      const statusEl = document.getElementById('loading-status');
      if (!conn) return;

      if (conn.saveData) {
        logDiagnostic('CONNECTION', 'Data saver enabled');
        if (statusEl) statusEl.textContent = 'Optimizing for data saver...';
      } else if (conn.effectiveType === '2g' || (conn.downlink || 0) < 1) {
        logDiagnostic('CONNECTION', 'Slow connection detected');
        if (statusEl) statusEl.textContent = 'Slow connection, loading essentials...';
      }
    }

    function announceToScreenReader(message) {
      const announcer = document.createElement('div');
      announcer.setAttribute('role', 'status');
      announcer.setAttribute('aria-live', 'polite');
      announcer.style.position = 'absolute';
      announcer.style.left = '-10000px';
      announcer.textContent = message;
      document.body.appendChild(announcer);
      setTimeout(() => announcer.remove(), 1000);
    }

    async function bootstrap() {
      logDiagnostic('BOOTSTRAP', 'Starting VMQ bootstrap');

      adaptLoadingToConnection();
      await warmupMLModels();

      const criticalOk = await checkEngineHealth();
      if (!criticalOk) {
        logDiagnostic('BOOTSTRAP', 'âš ï¸ Critical engines missing; continuing in degraded mode');
        const el = document.getElementById('loading-status');
        if (el) el.textContent = 'Some features unavailable, continuing...';
      }

      await prefetchUserModules();
      await registerServiceWorker();

      window.vmqMetrics.engineInitTime = Math.round(performance.now() - startTime);
      logDiagnostic('BOOTSTRAP', `Complete: ${window.vmqMetrics.engineInitTime}ms`);
    }

    bootstrap().then(() => {
      const loadingScreen = document.getElementById('loading-screen');
      const progressFill = loadingScreen?.querySelector('.progress-fill');

      if (progressFill) progressFill.style.setProperty('--width', '100%');
      announceToScreenReader('Violin Mastery Quest is ready');

      setTimeout(() => {
        if (loadingScreen) loadingScreen.classList.remove('active');
        window.dispatchEvent(new CustomEvent('vmq-ready', {
          detail: { metrics: window.vmqMetrics, diagnosticLog }
        }));
      }, 300);
    }).catch(err => {
      logDiagnostic('BOOTSTRAP', 'Fatal error during bootstrap', err);

      const overlay = document.getElementById('diagnostic-overlay');
      if (overlay) {
        overlay.style.display = 'flex';
        const logEl = document.getElementById('diagnostic-log');
        if (logEl) logEl.textContent = diagnosticLog.join('\\n') + '\\n\\n' + (err?.stack || String(err));
      }
    });

    document.getElementById('diagnostic-reload')?.addEventListener('click', () => window.location.reload());
  </script>

  <!-- VMQ APP ENTRY -->
  <script type="module" src="./js/App.js"></script>
</body>
</html>