<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ðŸŽ¯ PERFORMANCE (Critical Meta) -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover, user-scalable=no">
  <meta name="theme-color" content="#3b82f6">
  <meta name="color-scheme" content="light dark">
  
  <!-- ðŸŽ¯ PWA (Installable + Offline) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Violin Mastery Quest">
  <meta name="application-name" content="VMQ">
  
  <!-- ðŸŽ¯ SEO + Social (50+ modules) -->
  <meta name="description" content="Violin Mastery Quest v2.1.1 - 50+ modules with Ida Bieler Method: intervals, fingerboard, scales, rhythm, SM-2, coach AI">
  <title>Violin Mastery Quest v2.1.1</title>
  
  <!-- ðŸŽ¯ Open Graph -->
  <meta property="og:title" content="Violin Mastery Quest v2.1.1">
  <meta property="og:description" content="Offline violin training: Bieler Method + AI Coach + 50+ modules">
  <meta property="og:image" content="./icons/icon-512.png">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://vmq.app">
  
  <!-- ðŸŽ¯ PWA Manifest -->
  <link rel="manifest" href="./manifest.json">
  
  <!-- ðŸŽ¯ Core Icons (All sizes) -->
  <link rel="icon" type="image/png" sizes="32x32" href="./icons/icon-32.png">
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="./icons/icon-192.png">
  <link rel="mask-icon" href="./icons/icon-192.png" color="#3b82f6">
  
  <!-- ðŸŽ¯ PERFORMANCE (Preconnect + DNS) -->
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="dns-prefetch" href="https://unpkg.com">
  
  <!-- ðŸŽ¯ Critical CSS (Above-the-fold) -->
  <link rel="preload" href="./css/base.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="./css/base.css"></noscript>
  <link rel="preload" href="./css/components.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="./css/components.css"></noscript>
  <link rel="preload" href="./css/themes.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="./css/themes.css"></noscript>
  <link rel="preload" href="./css/animations.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="./css/animations.css"></noscript>
  
  <!-- ðŸŽ¯ Core Web Vitals -->
  <link rel="preload" href="./js/App.js" as="script">
</head>

<body>
  <!-- ðŸŽ¯ APP ROOT (6-Engine Context) -->
  <div id="root">
    <!-- ðŸš€ Loading Screen (Progressive Enhancement) -->
    <div class="loading-screen active" id="loading-screen">
      <div class="loading-spinner"></div>
      <div class="loading-content">
        <h1 class="loading-title">Violin Mastery Quest</h1>
        <p class="loading-subtitle">v2.1.1 - 50+ Modules + 6 Engines LIVE</p>
        <div class="loading-progress">
          <div class="progress-bar">
            <div class="progress-fill" style="--width: 0%"></div>
          </div>
        </div>
        <p class="loading-status">Initializing 6 engines...</p>
      </div>
    </div>
    
    <!-- ðŸŽ¯ Toast Container (Global) -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- ðŸŽ¯ App Content (React takeover) -->
    <div class="app-wrapper" id="app-content" style="display: none;">
      <!-- React renders here -->
    </div>
  </div>

  <!-- ðŸŽ¯ REACT 18 PRODUCTION (Tree-shaken UMD) - FIXED âœ… -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- ðŸŽ¯ VMQ BOOTSTRAP (Performance Optimized + v2.1.1) -->
  <script type="module">
    // ðŸŽ¯ PERFORMANCE MONITORING
    const startTime = performance.now();
    
    // ðŸŽ¯ PWA INSTALL PROMPT
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.documentElement.style.setProperty('--pwa-available', 'true');
    });
    
    // ðŸŽ¯ SERVICE WORKER (Production caching v2.1.1)
    if ('serviceWorker' in navigator) {
      const swUrl = './sw.js';
      
      navigator.serviceWorker.register(swUrl, { scope: './' })
        .then(registration => {
          console.log('âœ… VMQ SW v2.1.1 active:', registration.scope);
          
          // ðŸŽ¯ Update available (ToastSystem integration)
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed') {
                if (navigator.serviceWorker.controller) {
                  document.documentElement.style.setProperty('--sw-update', 'true');
                  // Trigger VMQToast update notification
                  window.dispatchEvent(new CustomEvent('vmq-update-available'));
                }
              }
            });
          });
        })
        .catch(err => console.warn('âš ï¸ SW failed:', err));
      
      // ðŸŽ¯ Controller change (reload)
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        window.location.reload();
      });
    }
    
    // ðŸŽ¯ MOBILE OPTIMIZATIONS
    if ('ontouchstart' in window) {
      document.documentElement.classList.add('touch-device');
      // Prevent double-tap zoom
      let lastTouchEnd = 0;
      document.addEventListener('touchend', (e) => {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) {
          e.preventDefault();
        }
        lastTouchEnd = now;
      }, false);
    }
    
    // ðŸŽ¯ THEME SYSTEM (Persisted + System)
    const savedTheme = localStorage.getItem('vmq-theme') || 
                       (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    
    document.documentElement.setAttribute('data-theme', savedTheme);
    document.documentElement.setAttribute('data-font-size', localStorage.getItem('vmq-font-size') || 'base');
    
    // ðŸŽ¯ ACCESSIBILITY (Auto-detect)
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      document.documentElement.style.setProperty('--reduced-motion', 'true');
    }
    
    // ðŸŽ¯ COREWEB VITALS (Performance budget)
    window.vmqMetrics = {
      fcp: 0,
      fid: 0,
      cls: 0,
      loadTime: 0
    };
    
    // ðŸŽ¯ BOOTSTRAP COMPLETE
    new PerformanceObserver((list) => {
      const entries = list.getEntries();
      const lastEntry = entries[entries.length - 1];
      window.vmqMetrics.loadTime = Math.round(lastEntry.startTime);
      
      // ðŸŽ¯ Hide loading + show app
      const loadingScreen = document.getElementById('loading-screen');
      const appContent = document.getElementById('app-content');
      
      // ðŸŽ¯ Progressive loading animation
      const progressFill = loadingScreen.querySelector('.progress-fill');
      progressFill.style.setProperty('--width', '100%');
      
      setTimeout(() => {
        loadingScreen.classList.remove('active');
        appContent.style.display = 'flex';
        console.log(`ðŸš€ VMQ v2.1.1 loaded: ${Math.round(performance.now() - startTime)}ms`);
      }, 800);
    }).observe({ entryTypes: ['paint'] });
  </script>

  <!-- ðŸŽ¯ VMQ APP ENTRY (ES Modules + Tree-shaking) -->
  <script type="module" src="./js/App.js"></script>
</body>
</html>
