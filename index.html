<!doctype html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#3b82f6" />
  <meta name="color-scheme" content="light dark" />

  <!-- PWA / Apple -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Violin Mastery Quest" />
  <meta name="application-name" content="VMQ" />
  <meta name="description" content="Violin Mastery Quest â€” adaptive violin training: intervals, fingerboard, scales, rhythm, SM-2, AI coach." />

  <!-- CSP: compatible with inline module bootstrap + React UMD -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' https://unpkg.com 'unsafe-inline';
          style-src 'self' 'unsafe-inline';
          img-src 'self' data: blob:;
          font-src 'self' data:;
          connect-src 'self' https://unpkg.com;
          media-src 'self' blob:;
          worker-src 'self' blob:;
          object-src 'none';
          base-uri 'self';
          frame-ancestors 'none';
        " />

  <title>Violin Mastery Quest</title>

  <meta property="og:title" content="Violin Mastery Quest" />
  <meta property="og:description" content="Adaptive violin training: Bieler Method + spaced repetition + AI coach" />
  <meta property="og:image" content="./icons/icon-512.png" />
  <meta property="og:type" content="website" />

  <link rel="manifest" href="./manifest.json" />

  <link rel="icon" type="image/png" sizes="16x16" href="./icons/icon-16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="./icons/icon-32.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="./icons/icon-180.png" />

  <link rel="preconnect" href="https://unpkg.com" crossorigin />
  <link rel="dns-prefetch" href="https://unpkg.com" />

  <!-- Deterministic CSS order -->
  <link rel="stylesheet" href="./css/base.css" />
  <link rel="preload" href="./css/themes.css" as="style" />
  <link rel="preload" href="./css/components.css" as="style" />
  <link rel="preload" href="./css/animations.css" as="style" />
  <link rel="stylesheet" href="./css/themes.css" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="./css/components.css" media="print" onload="this.media='all'">
  <link rel="stylesheet" href="./css/animations.css" media="print" onload="this.media='all'">
  <noscript>
    <link rel="stylesheet" href="./css/themes.css">
    <link rel="stylesheet" href="./css/components.css">
    <link rel="stylesheet" href="./css/animations.css">
  </noscript>

  <!-- Ensure slash-less rgb var compatibility -->
  <style>:root { --primary-rgb: 59 130 246; }</style>

  <!-- React 18 UMD (App.js uses window.React / window.ReactDOM) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Minimal boot-fallback styling (safe if CSS fails) -->
  <style>
    .vmq-fatal { margin-top:12px; padding:12px; border:1px solid rgba(239,68,68,.65);
      background:rgba(239,68,68,.08); border-radius:12px; text-align:left;
      max-width:620px; word-break:break-word; font-family:ui-monospace,Menlo,monospace; font-size:12px; }
    .vmq-fatal b{font-weight:800}
  </style>
</head>

<body>
  <!-- Shell stays visible until React dispatches vmq-app-mounted -->
  <div class="loading-screen active" id="loading-screen" aria-live="polite">
    <div class="loading-content" style="text-align:center">
      <div class="loading-spinner" style="width:clamp(48px, 12vw, 64px);height:clamp(48px, 12vw, 64px);margin:0 auto var(--space-xl)"></div>
      <h1 class="loading-title">Violin Mastery Quest</h1>
      <p class="loading-subtitle">Adaptive modules â€¢ Offline-ready</p>

      <div class="loading-progress" style="margin:var(--space-lg) 0 0">
        <div class="progress-bar" style="width:220px;margin:0 auto">
          <div class="progress-fill" id="loading-progress-fill" style="width:0%"></div>
        </div>
      </div>

      <p class="loading-status" id="loading-status">Initializingâ€¦</p>
      <div class="engine-status" id="engine-status" aria-live="polite" style="margin-top:10px"></div>

      <div id="vmq-fatal-box" class="vmq-fatal" style="display:none;"></div>

      <div style="margin-top:10px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap">
        <button class="btn btn-primary" type="button" id="vmq-reload-btn">Reload</button>
        <button class="btn btn-secondary" type="button" id="vmq-recover-btn">Recover (clear SW/cache)</button>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toast-container"></div>
  <div id="root"></div>

  <script type="module">
    // --------------------------------------------
    // VMQ index.html â€” Drop-in bootstrap v3.0.7
    // --------------------------------------------
    const BASE_URL  = new URL('./', import.meta.url);     // GH Pages safe
    const BASE_PATH = BASE_URL.pathname;                  // "/violin-mastery-quest/" or "/"
    const APP_URL   = new URL('./js/App.js', BASE_URL).href;
    const SW_URL    = new URL('./sw.js', BASE_URL).href;

    window.__VMQ_BASE_PATH__ = BASE_PATH;
    window.__VMQ_APP_URL__   = APP_URL;

    const $status = document.getElementById('loading-status');
    const $bar    = document.getElementById('loading-progress-fill');
    const $eng    = document.getElementById('engine-status');
    const $fatal  = document.getElementById('vmq-fatal-box');
    const $shell  = document.getElementById('loading-screen');

    const isDiagnosticMode =
      new URL(location.href).searchParams.get('vmq-diagnostics') === '1' ||
      new URL(location.href).searchParams.get('debug') === 'true';

    const RECOVERY_KEY = 'vmq-recovery-attempted-v1';
    const recoveryAttempted = sessionStorage.getItem(RECOVERY_KEY) === '1';

    function setStatus(t) { if ($status) $status.textContent = t; }
    function setProgress(p) { if ($bar) $bar.style.width = `${Math.max(0, Math.min(100, p))}%`; }

    function extractUrl(text) {
      const s = String(text || '');
      const m =
        s.match(/https?:\/\/[^\s'"]+/) ||
        s.match(/(?:\.\/|\/)js\/[^\s'"]+\.js(?:\?[^\s'"]+)?/);
      return m ? m[0] : null;
    }

    function showBootFatal(title, info = {}) {
      if (!$fatal) return;
      const sw =
        ('serviceWorker' in navigator)
          ? (navigator.serviceWorker.controller ? 'controlling' : 'not controlling')
          : 'unsupported';
      const basePath = window.__VMQ_BASE_PATH__ || '(unknown)';
      const appUrl = window.__VMQ_APP_URL__ || '(unknown)';
      const msg = info.message || '';
      const url =
        info.failingUrl ||
        extractUrl(msg) ||
        extractUrl(info.stack) ||
        '(not found)';

      $fatal.style.display = 'block';
      $fatal.innerHTML =
        `<div style="font-weight:900;margin-bottom:6px;">ðŸš¨ ${title}</div>` +
        `<div><b>Failing URL:</b> ${url}</div>` +
        `<div><b>App URL:</b> ${appUrl}</div>` +
        `<div><b>Base path:</b> ${basePath}</div>` +
        `<div><b>SW:</b> ${sw}</div>` +
        (msg ? `<div style="margin-top:6px;"><b>Message:</b> ${msg}</div>` : '') +
        (info.stack ? `<div style="margin-top:6px;white-space:pre-wrap;"><b>Stack:</b>\n${info.stack}</div>` : '');
    }

    async function purgeServiceWorkerAndCaches() {
      const report = { action: 'purge', ok: true, sw: [], caches: [], ts: Date.now() };
      try {
        if ('serviceWorker' in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          report.sw = regs.map(r => ({ scope: r.scope, active: !!r.active, waiting: !!r.waiting, installing: !!r.installing }));
          await Promise.all(regs.map(r => r.unregister()));
        }
        if ('caches' in window) {
          const keys = await caches.keys();
          report.caches = keys.slice();
          await Promise.all(keys.map(k => caches.delete(k)));
        }
      } catch (e) {
        report.ok = false;
        report.error = e?.message || String(e);
      }
      return report;
    }

    document.getElementById('vmq-reload-btn')?.addEventListener('click', () => location.reload());
    document.getElementById('vmq-recover-btn')?.addEventListener('click', async () => {
      setStatus('Recoveringâ€¦');
      await purgeServiceWorkerAndCaches();
      location.href = `${BASE_URL.href}?recovered=1&t=${Date.now()}`;
    });

    // Global error capture (helps when Safari doesnâ€™t surface module errors well)
    window.__VMQ_LAST_ERROR__ = null;
    window.addEventListener('error', (event) => {
      window.__VMQ_LAST_ERROR__ = {
        message: event.message,
        stack: event?.error?.stack || '',
        failingUrl: event.filename || extractUrl(event.message) || null
      };
      if (isDiagnosticMode) console.warn('[VMQ] window.error:', window.__VMQ_LAST_ERROR__);
    });

    window.addEventListener('unhandledrejection', (event) => {
      const r = event?.reason;
      window.__VMQ_LAST_ERROR__ = {
        message: r?.message || String(r),
        stack: r?.stack || '',
        failingUrl: extractUrl(r?.message) || extractUrl(String(r)) || null
      };
      if (isDiagnosticMode) console.warn('[VMQ] unhandledrejection:', window.__VMQ_LAST_ERROR__);
    });

    // Do not hide shell until App.js dispatches vmq-app-mounted
    let mounted = false;
    window.addEventListener('vmq-app-mounted', (e) => {
      mounted = true;
      $shell?.classList.remove('active');
      setStatus(`Live${e?.detail?.version ? ' â€¢ v' + e.detail.version : ''}`);
    }, { once: true });

    async function registerServiceWorker() {
      if (!('serviceWorker' in navigator)) return { supported: false };

      // single-owner guard
      if (window.__VMQ_SW_REG_GUARD__) return { guarded: true };
      window.__VMQ_SW_REG_GUARD__ = true;

      try {
        const reg = await navigator.serviceWorker.register(SW_URL, {
          scope: BASE_PATH,
          updateViaCache: 'none'
        });
        return { supported: true, ok: true, scope: reg.scope, controlling: !!navigator.serviceWorker.controller };
      } catch (e) {
        return { supported: true, ok: false, error: e?.message || String(e) };
      }
    }

    // Optional: very lightweight engine presence check (non-fatal)
    async function softEngineProbe() {
      const names = ['audioEngine','gamification','sessionTracker','analytics','spacedRepetition','difficultyAdapter'];
      const out = [];
      for (const n of names) {
        try {
          const url = new URL(`./js/engines/${n}.js`, BASE_URL).href;
          const res = await fetch(url, { cache: 'no-store' });
          out.push(`${res.ok ? 'âœ…' : 'âŒ'} ${n}`);
        } catch {
          out.push(`âŒ ${n}`);
        }
      }
      if ($eng) $eng.textContent = out.join('  â€¢  ');
    }

    async function tryRecoverOnce(reason, detail = {}) {
      if (recoveryAttempted) return false;
      sessionStorage.setItem(RECOVERY_KEY, '1');

      setStatus('Auto-recoveringâ€¦');
      await purgeServiceWorkerAndCaches();
      if (isDiagnosticMode) console.warn('[VMQ] Auto-recover reason:', reason, detail);

      location.href = `${BASE_URL.href}?autofix=1&t=${Date.now()}`;
      return true;
    }

    // Boot sequence
    (async () => {
      setProgress(10);
      setStatus('Checking environmentâ€¦');

      if (!window.React || !window.ReactDOM) {
        showBootFatal('React failed to load', { message: 'React UMD globals missing.' });
        return;
      }

      setProgress(20);
      await softEngineProbe();

      setProgress(35);
      setStatus('Registering offline supportâ€¦');
      await registerServiceWorker();

      // Mount timeout: keep shell + show fatal + attempt one-time recovery
      const MOUNT_TIMEOUT_MS = 12000;
      setTimeout(async () => {
        if (mounted) return;
        setStatus('Mount timeout (React never mounted)');
        showBootFatal('Mount timeout (React never mounted)', window.__VMQ_LAST_ERROR__ || {});
        await tryRecoverOnce('mount-timeout', window.__VMQ_LAST_ERROR__ || {});
      }, MOUNT_TIMEOUT_MS);

      setProgress(55);
      setStatus('Loading app moduleâ€¦');

      try {
        await import(APP_URL);  // App.js runs its own bootstrap + dispatches vmq-app-mounted
        setProgress(90);
        setStatus('Finalizingâ€¦');
      } catch (e) {
        const payload = {
          message: e?.message || String(e),
          stack: e?.stack || '',
          failingUrl: extractUrl(e?.message) || extractUrl(e?.stack) || null
        };
        setStatus('Importing a module script failed.');
        showBootFatal('Importing a module script failed.', payload);
        await tryRecoverOnce('module-import-failed', payload);
      }
    })();
  </script>
</body>
</html>
